<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conversor de Audio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.10/umd/ffmpeg.min.js"></script>
</head>
<body>
    <input type="file" id="audioFile" accept=".mp3">
    <input type="text" id="fileName" placeholder="Nombre del archivo">
    <input type="text" id="artistName" placeholder="Nombre del artista">
    <button onclick="convertAndTagAudio()">Convertir y Etiquetar</button>
    <audio id="audioPlayer" controls style="display:none;"></audio>

    <script>
      let ffmpegLoaded = false;
      const { createFFmpeg, fetchFile } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: true });

      async function loadFFmpeg() {
        if (!ffmpegLoaded) {
          await ffmpeg.load();
          ffmpegLoaded = true;
        }
      }

      async function convertAndTagAudio() {
        const audioFile = document.getElementById('audioFile').files[0];
        const fileName = document.getElementById('fileName').value;
        const artistName = document.getElementById('artistName').value;

        if (!audioFile) {
            alert('Por favor, selecciona un archivo de audio.');
            return;
        }

        try {
            await loadFFmpeg(); // Aseg√∫rate de cargar ffmpeg antes de usarlo.

            // Convertir el formato del archivo a m4a
            await ffmpeg.FS('writeFile', audioFile.name, await fetchFile(audioFile));
            await ffmpeg.run('-i', audioFile.name, '-vn', '-acodec', 'aac', `${fileName}.m4a`);
            const data = ffmpeg.FS('readFile', `${fileName}.m4a`);

            const audioBlob = new Blob([data.buffer], { type: 'audio/mp4' });
            displayAndDownloadFile(audioBlob, fileName);

        } catch (error) {
            alert('Hubo un error al procesar tu archivo: ' + error.message);
        }
    }

    function displayAndDownloadFile(audioBlob, fileName) {
        const url = URL.createObjectURL(audioBlob);
        const a = document.createElement('a');
        const audioPlayer = document.getElementById('audioPlayer');
        
        // Configurar el elemento de descarga
        a.href = url;
        a.download = fileName + '.m4a';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // Configurar el reproductor de audio para mostrar el archivo
        audioPlayer.src = url;
        audioPlayer.style.display = 'block';
    }
    </script>
</body>
</html>
